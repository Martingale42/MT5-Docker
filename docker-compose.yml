version: '3.8'
services:
  mt5zmq:
    build: .
    image: mt5zmq:latest
    container_name: mt5zmq
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "/scripts/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    ports:
      - '5900:5900'    # VNC (localhost only)
      - '127.0.0.1:2201:2201'    # System socket (REQ/REP)
      - '127.0.0.1:2202:2202'    # Data socket (PUSH)
      - '127.0.0.1:2203:2203'    # Live socket (PUSH)
      - '127.0.0.1:2204:2204'    # Stream socket (PUSH)
    volumes:
      # Wine prefix and MT5 installation (persists across restarts)
      - mt5zmq-config:/config
      # Local MQL5 directory (for live editing)
      - ./Metatrader/MQL5:/mql5
      # Data directory
      - ./data:/root/data
    environment:
      - USER=root
      - PASSWORD=root
      - VNC_PASSWORD=${VNC_PASSWORD:-mt5pass}
      - WINEDEBUG=-toolbar
      - MT5_WATCHDOG_ENABLED=${MT5_WATCHDOG_ENABLED:-true}
      - MT5_WATCHDOG_INTERVAL=${MT5_WATCHDOG_INTERVAL:-30}
      - MT5_WATCHDOG_MAX_RETRIES=${MT5_WATCHDOG_MAX_RETRIES:-3}
    deploy:
      resources:
        limits:
          cpus: '4'          # Max 4 cores
          memory: 2G         # Max 2GB
        reservations:
          cpus: '4'          # Guaranteed 2 cores
          memory: 1G         # Guaranteed 2G

  # swagger-ui:
  #   image: nginx:alpine
  #   container_name: mt5-swagger-ui
  #   restart: unless-stopped
  #   ports:
  #     - '8080:80'
  #   volumes:
  #     - ./docs/openapi:/usr/share/nginx/html:ro
  #   profiles:
  #     - docs
  #   depends_on:
  #     - mt5zmq

  # mt5-exporter:
  #   build: .
  #   image: mt5zmq:latest
  #   container_name: mt5-exporter
  #   restart: unless-stopped
  #   command: python3 /root/monitoring/prometheus_exporter.py --port 9090 --mt5-host mt5zmq --interval 30
  #   ports:
  #     - '9090:9090'
  #   volumes:
  #     - ./monitoring:/root/monitoring:ro
  #     - ./scripts:/root/scripts:ro
  #   profiles:
  #     - monitoring
  #   depends_on:
  #     - mt5zmq

  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: mt5-prometheus
  #   restart: unless-stopped
  #   ports:
  #     - '9091:9090'
  #   volumes:
  #     - ./monitoring/prometheus:/etc/prometheus:ro
  #     - prometheus-data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--web.console.libraries=/usr/share/prometheus/console_libraries'
  #     - '--web.console.templates=/usr/share/prometheus/consoles'
  #   profiles:
  #     - monitoring
  #   depends_on:
  #     - mt5-exporter

  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: mt5-grafana
  #   restart: unless-stopped
  #   ports:
  #     - '3000:3000'
  #   volumes:
  #     - grafana-data:/var/lib/grafana
  #     - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
  #   environment:
  #     - GF_SECURITY_ADMIN_USER=admin
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #     - GF_USERS_ALLOW_SIGN_UP=false
  #   profiles:
  #     - monitoring
  #   depends_on:
  #     - prometheus

volumes:
  # Persists Wine prefix, MT5 installation, and all MT5 data
  mt5zmq-config:
  # prometheus-data:
  # grafana-data: